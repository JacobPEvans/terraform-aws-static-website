name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  terraform-validate:
    name: Terraform Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "~1.6"

      - name: Terraform Format Check
        run: terraform fmt -check -recursive

      - name: Terraform Init
        run: terraform init -backend=false

      - name: Terraform Validate
        run: terraform validate

  tflint:
    name: TFLint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: v0.50.0

      - name: Show TFLint version
        run: tflint --version

      - name: Init TFLint
        run: tflint --init

      - name: Run TFLint
        run: tflint --recursive --config=${{ github.workspace }}/.tflint.hcl

  trivy:
    name: Trivy Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'HIGH,CRITICAL'
          exit-code: '0'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "~1.6"
          terraform_wrapper: false

      - name: Cache Go modules
        uses: actions/cache@v3
        with:
          path: |
            ~/go/pkg/mod
            ~/.cache/go-build
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum', '**/go.mod') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Download Go dependencies
        working-directory: tests
        run: go mod download

      - name: Run Resource Structure Tests
        working-directory: tests
        run: |
          echo "Testing S3 bucket resources..."
          go test -v -run TestS3BucketResourcesIndividually -timeout 5m

          echo "Testing CloudFront resources..."
          go test -v -run TestCloudFrontResources -timeout 5m

          echo "Testing Route53 resources..."
          go test -v -run TestRoute53Resources -timeout 5m

      - name: Run Module Validation Tests
        working-directory: tests
        run: go test -v -run TestModuleValidation -timeout 10m

  localstack-tests:
    name: LocalStack Integration Tests
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "~1.6"
          terraform_wrapper: false

      - name: Cache Go modules
        uses: actions/cache@v3
        with:
          path: |
            ~/go/pkg/mod
            ~/.cache/go-build
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum', '**/go.mod') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Start LocalStack
        run: |
          docker-compose up -d
          echo "Waiting for LocalStack to be ready..."
          sleep 15
          docker-compose ps
          docker-compose logs --tail=50 localstack

      - name: Download Go dependencies
        working-directory: tests
        run: go mod download

      - name: Run Integration Tests
        working-directory: tests
        env:
          AWS_ACCESS_KEY_ID: test
          AWS_SECRET_ACCESS_KEY: test
          AWS_DEFAULT_REGION: us-east-1
        run: |
          echo "Running LocalStack integration tests..."
          go test -v -run "TestTerraformAwsStaticWebsiteBasic|TestTerraformAwsStaticWebsiteSPA" -timeout 30m
        continue-on-error: true

      - name: Show LocalStack logs
        if: always()
        run: |
          echo "=== LocalStack Container Status ==="
          docker-compose ps
          echo "=== LocalStack Logs ==="
          docker-compose logs --tail=100 localstack

      - name: Stop LocalStack
        if: always()
        run: docker-compose down -v
